(function(){var t=this,i=function(t){if(!t||!t.canvas||!t.path)throw"Zoomage constructor: missing arguments canvas or path";this.canvas=t.canvas,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.context=this.canvas.getContext("2d"),this.desktop=t.desktop||!1,this.position={x:0,y:0},this.scale={x:.5,y:.5},this.imgTexture=new Image,this.imgTexture.src=t.path,this.lastZoomScale=null,this.lastX=null,this.lastY=null,this.mdown=!1,this.init=!1,this.checkRequestAnimationFrame(),requestAnimationFrame(this.animate.bind(this)),this.setEventListeners()};i.prototype={animate:function(){if(!this.init&&this.imgTexture.width&&this.imgTexture.height){var t=1;this.imgTexture.width>this.imgTexture.height?this.canvas.clientWidth<this.imgTexture.width?(t=this.canvas.clientWidth/this.imgTexture.width,this.position.y=(this.canvas.clientHeight-t*this.imgTexture.height)/2):(this.position.x=(this.canvas.clientWidth-this.imgTexture.width)/2,this.position.y=(this.canvas.clientHeight-this.imgTexture.height)/2):this.canvas.clientWidth<this.imgTexture.width?(t=this.canvas.clientHeight/this.imgTexture.height,this.position.x=(this.canvas.clientWidth-t*this.imgTexture.width)/2):(this.position.x=(this.canvas.clientWidth-this.imgTexture.width)/2,this.position.y=(this.canvas.clientHeight-this.imgTexture.height)/2),this.scale.x=t,this.scale.y=t,this.init=!0}this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.imgTexture,this.position.x,this.position.y,this.scale.x*this.imgTexture.width,this.scale.y*this.imgTexture.height),requestAnimationFrame(this.animate.bind(this))},gesturePinchZoom:function(t){var i=!1;if(t.targetTouches.length>=2){var e=t.targetTouches[0],s=t.targetTouches[1],h=Math.sqrt(Math.pow(s.pageX-e.pageX,2)+Math.pow(s.pageY-e.pageY,2));this.lastZoomScale&&(i=h-this.lastZoomScale),this.lastZoomScale=h}return i},doZoom:function(t){if(t){var i=this.scale.x,e=this.scale.x+t/100,s=e-i,h=this.imgTexture.width*s,n=this.imgTexture.height*s,a=this.position.x-h/2,o=this.position.y-n/2;e*this.imgTexture.width>2*this.canvas.width||e*this.imgTexture.height>2*this.canvas.height||e*this.imgTexture.width<.3*this.canvas.width||e*this.imgTexture.height<.3*this.canvas.height||(this.scale.x=e,this.scale.y=e,this.position.x=a,this.position.y=o)}},doMove:function(t,i){if(this.lastX&&this.lastY){var e=t-this.lastX,s=i-this.lastY;this.imgTexture.width*this.scale.x,this.imgTexture.height*this.scale.y;this.position.x+=e,this.position.y+=s}this.lastX=t,this.lastY=i},setEventListeners:function(){this.canvas.addEventListener("touchstart",function(t){this.lastX=null,this.lastY=null,this.lastZoomScale=null}.bind(this)),this.canvas.addEventListener("touchmove",function(t){if(t.preventDefault(),2==t.targetTouches.length)this.doZoom(this.gesturePinchZoom(t));else if(1==t.targetTouches.length){var i=t.targetTouches[0].pageX-this.canvas.getBoundingClientRect().left,e=t.targetTouches[0].pageY-this.canvas.getBoundingClientRect().top;this.doMove(i,e)}}.bind(this)),this.desktop&&(window.addEventListener("keyup",function(t){187==t.keyCode||61==t.keyCode?this.doZoom(5):54==t.keyCode&&this.doZoom(-5)}.bind(this)),window.addEventListener("mousedown",function(t){this.mdown=!0,this.lastX=null,this.lastY=null}.bind(this)),window.addEventListener("mouseup",function(t){this.mdown=!1}.bind(this)),window.addEventListener("mousemove",function(t){var i=t.pageX-this.canvas.getBoundingClientRect().left,e=t.pageY-this.canvas.getBoundingClientRect().top;t.target==this.canvas&&this.mdown&&this.doMove(i,e),(i<=0||i>=this.canvas.clientWidth||e<=0||e>=this.canvas.clientHeight)&&(this.mdown=!1)}.bind(this)))},checkRequestAnimationFrame:function(){for(var t=0,i=["ms","moz","webkit","o"],e=0;e<i.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[i[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i,e){var s=(new Date).getTime(),h=Math.max(0,16-(s-t)),n=window.setTimeout(function(){i(s+h)},h);return t=s+h,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}},t.Zoomage=i}).call(this);