(function(){var t=this,i=function(t){if(!t||!t.canvas||!t.path)throw"Zoomage constructor: missing arguments canvas or path";this.canvas=t.canvas,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.context=this.canvas.getContext("2d"),this.onZoom=t.onZoom||null,this.onZoomEnd=t.onZoomEnd||null,this.context.save(),this.isTouching=!1,this.isFirstTime=!0,this.isImgLoaded=!1,this.desktop=t.desktop||!1,this.lastTouchEndTimestamp=null,this.lastTouchEndObject=null,this.dbclickZoomToggle=!0,this.dbclickZoomLength=0,this.dbclickZoomThreshold=t.dbclickZoomThreshold||20,this.position={x:0,y:0},this.scale={x:.5,y:.5},this.rotate={position:{x:0,y:0},degree:0},this.imgTexture=new Image,this.imgTexture.src=t.path,this.lastZoomScale=null,this.lastX=null,this.lastY=null,this.deltaRotate=null,this.mdown=!1,this.init=!1,this._checkRequestAnimationFrame(),requestAnimationFrame(this._animate.bind(this)),this._setEventListeners()};i.prototype={_animate:function(){if(!this.init&&this.imgTexture.width&&this.imgTexture.height){var t=1;this.imgTexture.width>this.imgTexture.height?this.canvas.clientWidth<this.imgTexture.width?(t=this.canvas.clientWidth/this.imgTexture.width,this.position.y=(this.canvas.clientHeight-t*this.imgTexture.height)/2):(this.position.x=(this.canvas.clientWidth-this.imgTexture.width)/2,this.position.y=(this.canvas.clientHeight-this.imgTexture.height)/2):this.canvas.clientWidth<this.imgTexture.width?(t=this.canvas.clientHeight/this.imgTexture.height,this.position.x=(this.canvas.clientWidth-t*this.imgTexture.width)/2):(this.position.x=(this.canvas.clientWidth-this.imgTexture.width)/2,this.position.y=(this.canvas.clientHeight-this.imgTexture.height)/2),this.scale.x=t,this.scale.y=t,this.init=!0}this.isTouching?this.context.clearRect(0,0,this.canvas.width,this.canvas.height):(this.context.restore(),this.context.save()),(this.isTouching||this.isFirstTime)&&this.isImgLoaded&&this.context.drawImage(this.imgTexture,this.position.x,this.position.y,this.scale.x*this.imgTexture.width,this.scale.y*this.imgTexture.height),this.isFirstTime=!1,requestAnimationFrame(this._animate.bind(this))},_gesturePinchZoom:function(t){var i=!1;if(t.targetTouches.length>=2){var e=t.targetTouches[0],s=t.targetTouches[1],h=Math.sqrt(Math.pow(s.pageX-e.pageX,2)+Math.pow(s.pageY-e.pageY,2));this.lastZoomScale&&(i=h-this.lastZoomScale),this.lastZoomScale=h}return i},_gestureRotate:function(t){var i=!1;if(t.targetTouches.length>=2){t.targetTouches[0],t.targetTouches[1]}return i},_doZoom:function(t){if(t){var i=this.scale.x,e=this.scale.x+t/100,s=e-i,h=this.imgTexture.width*s,n=this.imgTexture.height*s,o=this.position.x-h/2,a=this.position.y-n/2;return!(e*this.imgTexture.width>2.2*this.canvas.width||e*this.imgTexture.height>2.2*this.canvas.height||e*this.imgTexture.width<.2*this.canvas.width||e*this.imgTexture.height<.2*this.canvas.height)&&(this.scale.x=e,this.scale.y=e,this.position.x=o,this.position.y=a,this.isTouching=!0,"function"===this._type(this.onZoom)&&this.onZoom.call(this,{zoomScale:e,imageScale:{width:e*this.imgTexture.width,height:e*this.imgTexture.height}}),!0)}},_doMove:function(t,i){if(this.lastX&&this.lastY){var e=t-this.lastX,s=i-this.lastY;this.imgTexture.width*this.scale.x,this.imgTexture.height*this.scale.y;this.position.x+=e,this.position.y+=s}this.lastX=t,this.lastY=i},_doRotate:function(t){},_zoomInAnim:function(){var t=null,i=Math.round(this.dbclickZoomLength/10*2);if(this.dbclickZoomLength>0){if(!this._doZoom(i))return!1;this.dbclickZoomLength=this.dbclickZoomLength-i,t=requestAnimationFrame(this._zoomInAnim.bind(this))}else cancelAnimationFrame(t);return!0},_zoomOutAnim:function(){var t=null,i=Math.round(this.dbclickZoomLength/10*2);if(this.dbclickZoomLength>0){if(!this._doZoom(-i))return!1;this.dbclickZoomLength=this.dbclickZoomLength-i,t=requestAnimationFrame(this._zoomOutAnim.bind(this))}else cancelAnimationFrame(t);return!0},_setEventListeners:function(){this.canvas.addEventListener("touchend",function(t){if(this.isTouching=!1,null===this.lastTouchEndTimestamp||null===this.lastTouchEndObject)this.lastTouchEndTimestamp=Math.round((new Date).getTime()),this.lastTouchEndObject=t.changedTouches[0];else{var i=Math.round((new Date).getTime());i-this.lastTouchEndTimestamp<300&&Math.abs(this.lastTouchEndObject.pageX-t.changedTouches[0].pageX)<20&&Math.abs(this.lastTouchEndObject.pageY-t.changedTouches[0].pageY<20)&&(this.dbclickZoomLength=this.dbclickZoomThreshold,this.dbclickZoomToggle?this._zoomInAnim()||this._zoomOutAnim():this._zoomOutAnim()||this._zoomInAnim(),this.dbclickZoomToggle=!this.dbclickZoomToggle),this.lastTouchEndTimestamp=i,this.lastTouchEndObject=t.changedTouches[0]}}.bind(this)),this.canvas.addEventListener("touchstart",function(t){this.isTouching=!0,this.lastX=null,this.lastY=null,this.lastZoomScale=null}.bind(this)),this.canvas.addEventListener("touchmove",function(t){if(t.preventDefault(),2==t.targetTouches.length)this._doZoom(this._gesturePinchZoom(t));else if(1==t.targetTouches.length){var i=t.targetTouches[0].pageX-this.canvas.getBoundingClientRect().left,e=t.targetTouches[0].pageY-this.canvas.getBoundingClientRect().top;this._doMove(i,e)}}.bind(this)),this.imgTexture.addEventListener("load",function(t){this.isImgLoaded=!0,this.isFirstTime=!0}.bind(this)),this.desktop&&(window.addEventListener("keyup",function(t){187==t.keyCode||61==t.keyCode?this._doZoom(5):54==t.keyCode&&this._doZoom(-5)}.bind(this)),window.addEventListener("mousedown",function(t){this.mdown=!0,this.lastX=null,this.lastY=null}.bind(this)),window.addEventListener("mouseup",function(t){this.mdown=!1}.bind(this)),window.addEventListener("mousemove",function(t){var i=t.pageX-this.canvas.getBoundingClientRect().left,e=t.pageY-this.canvas.getBoundingClientRect().top;t.target==this.canvas&&this.mdown&&this._doMove(i,e),(i<=0||i>=this.canvas.clientWidth||e<=0||e>=this.canvas.clientHeight)&&(this.mdown=!1)}.bind(this)))},_type:function(t){var i={},e=i.toString;return i["[object Function]"]="function",null==t?t+"":"object"==typeof t||"function"==typeof t?i[e.call(t)]||"object":typeof t},_checkRequestAnimationFrame:function(){for(var t=0,i=["ms","moz","webkit","o"],e=0;e<i.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[i[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i,e){var s=(new Date).getTime(),h=Math.max(0,16-(s-t)),n=window.setTimeout(function(){i(s+h)},h);return t=s+h,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}},t.Zoomage=i}).call(this);